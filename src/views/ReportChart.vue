<template>
  <div class="container my-5">
    <h2 class="text-center mb-4">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</h2>

    <div class="text-center mb-4">
      <select
        v-model="selectedType"
        class="form-select w-auto d-inline-block"
        @change="fetchData"
      >
        <option value="daily">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</option>
      </select>
    </div>

    <div v-if="loading" class="text-center">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
    <div v-if="error" class="text-danger text-center">{{ error }}</div>

    <canvas v-show="!loading && !error" ref="reportChart" height="120"></canvas>
  </div>
</template>

<script>
import { ref, onMounted, nextTick } from "vue";
import { Chart, registerables } from "chart.js";
Chart.register(...registerables);

export default {
  name: "ReportChart",
  setup() {
    const loading = ref(true);
    const error = ref(null);
    const selectedType = ref("daily");
    const reportChart = ref(null);
    let chartInstance = null;

    // ‚ú® 4. ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏µ‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö‡∏ò‡∏µ‡∏°‡∏™‡∏ß‡πà‡∏≤‡∏á (‡πÅ‡∏î‡∏á‡∏™‡∏î, ‡∏°‡πà‡∏ß‡∏á‡∏™‡∏î)
    const statusColors = {
      "‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£": "rgba(255, 206, 86, 0.6)", // ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á
      "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥": "rgba(54, 162, 235, 0.6)", // ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô
      "‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß": "rgba(75, 192, 192, 0.6)", // ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
      "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å": "rgba(255, 99, 132, 0.6)", // ‡πÅ‡∏î‡∏á
      "default": "rgba(153, 102, 255, 0.6)", // ‡∏°‡πà‡∏ß‡∏á
    };

    const fetchData = async () => {
      loading.value = true;
      error.value = null;

      try {
        const res = await fetch(
          `http://localhost:8081/MK_SHOP/php_api/report_orders.php?type=${selectedType.value}`
        );
        const data = await res.json();

        if (!data.success) throw new Error(data.message);

        const labels = data.data.map((item) => item.label);
        const values = data.data.map((item) => parseFloat(item.total) || 0);

        await nextTick();

        if (chartInstance) chartInstance.destroy();

        const ctx = reportChart.value.getContext("2d");

        let chartLabel = "";
        let chartType = "bar";
        let bgColors = [];
        let borderColors = [];

        if (selectedType.value === "daily") {
          chartLabel = "‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô (‡∏ö‡∏≤‡∏ó)";
          chartType = "line";
          bgColors = ["rgba(157, 78, 221, 0.6)"]; // ‡∏™‡∏µ‡∏°‡πà‡∏ß‡∏á
          borderColors = ["rgba(157, 78, 221, 1)"];
        } else if (selectedType.value === "status") {
          chartLabel = "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞";
          chartType = "pie";
          bgColors = labels.map(
            (status) => statusColors[status] || statusColors["default"]
          );
          borderColors = bgColors.map((c) => c.replace("0.6", "1"));
        } else {
          // "product"
          chartLabel = "‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏ö‡∏≤‡∏ó)";
          chartType = "bar";
          bgColors = ["rgba(54, 162, 235, 0.6)"]; // ‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô
          borderColors = ["rgba(54, 162, 235, 1)"];
        }
        const options = {
          responsive: true,
          plugins: {
            legend: {
              position: "top",
              labels: { 
                // color: "#f4f4f4" // ‚ùå ‡∏•‡∏ö‡∏≠‡∏≠‡∏Å
              }, 
            },
            title: {
              display: true,
              text: chartLabel,
              // color: "#f4f4f4", // ‚ùå ‡∏•‡∏ö‡∏≠‡∏≠‡∏Å
            },
          },
          scales:
            chartType !== "pie"
              ? {
                  y: {
                    beginAtZero: true,
                    title: {
                      display: true,
                      text:
                        selectedType.value === "status"
                          ? "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå"
                          : "‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (‡∏ö‡∏≤‡∏ó)",
                    },
                    ticks: { 
                    }, 
                    grid: { 
                    }, 
                  },
                  x: {
                    ticks: { 
                    }, 
                    grid: {   
                    }, 
                  },
                }
              : {},
        };


        chartInstance = new Chart(ctx, {
          type: chartType,
          data: {
            labels,
            datasets: [
              {
                label: chartLabel,
                data: values,
                backgroundColor:
                  chartType === "pie" ? bgColors : bgColors[0],
                borderColor:
                  chartType === "pie" ? borderColors : borderColors[0],
                borderWidth: 1,
                fill: chartType === "line",
                tension: 0.3, 
              },
            ],
          },
          options: options, // ‚ú® 6. ‡πÉ‡∏ä‡πâ‡∏≠‡∏≠‡∏õ‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà (‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏µ‡∏ü‡∏≠‡∏ô‡∏ï‡πå)
        });
      } catch (err) {
        error.value = err.message;
      } finally {
        loading.value = false;
      }
    };

    onMounted(fetchData);

    return { loading, error, selectedType, fetchData, reportChart };
  },
};
</script>

<style scoped>
/* ‚ú® 7. ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ CSS ‡πÄ‡∏î‡∏¥‡∏° (‡∏•‡∏ö‡∏ò‡∏µ‡∏°‡∏°‡∏∑‡∏î‡∏≠‡∏≠‡∏Å) */
select.form-select {
  min-width: 250px;
}


</style>